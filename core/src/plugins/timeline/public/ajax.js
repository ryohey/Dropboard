// Generated by CoffeeScript 1.3.3
var LBAjax,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

LBAjax = (function() {

  function LBAjax() {
    this.upload = __bind(this.upload, this);

    this.write = __bind(this.write, this);

    this.more = __bind(this.more, this);

    this.update = __bind(this.update, this);

    this._diff = __bind(this._diff, this);

    this.page = __bind(this.page, this);
    this.MESSAGE_PER_PAGE = 15;
    this.lastData = [];
  }

  LBAjax.prototype.page = function(success, page, per) {
    lbNotify.progress("データ取得中");
    return $.getJSON("/timeline", {
      page: page,
      per: per
    }, function(data) {
      lbNotify.hide();
      return success(data);
    });
  };

  LBAjax.prototype._diff = function(success, page, per) {
    var _success,
      _this = this;
    _success = success;
    return this.page((function(data) {
      var diff;
      diff = messageDiff(_this.lastData, data);
      diff.sort(sortByDate);
      _success(diff);
      return _this.lastData = _this.lastData.concat(diff);
    }), page, per);
  };

  LBAjax.prototype.update = function(success) {
    return this._diff(success, 0, this.MESSAGE_PER_PAGE);
  };

  LBAjax.prototype.more = function(success) {
    return this._diff(success, Math.floor(this.lastData.length / this.MESSAGE_PER_PAGE), this.MESSAGE_PER_PAGE);
  };

  LBAjax.prototype.write = function(data, success) {
    var _this = this;
    lbNotify.progress("送信中");
    return $.post("/timeline", data, function(response) {
      if (response === "1") {
        lbNotify.hide();
        return success();
      } else {
        return lbNotify.warning("送信に失敗しました");
      }
    });
  };

  LBAjax.prototype.upload = function(files, success) {
    var fd, file, _i, _len;
    fd = new FormData();
    for (_i = 0, _len = files.length; _i < _len; _i++) {
      file = files[_i];
      fd.append("files", file);
    }
    lbNotify.progress("アップロード中");
    return $.ajax({
      url: "/upload",
      type: "post",
      data: fd,
      processData: false,
      contentType: false,
      success: function(response) {
        lbNotify.hide();
        return success(response);
      }
    });
  };

  return LBAjax;

})();
