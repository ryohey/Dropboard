// Generated by CoffeeScript 1.10.0
var LBAjax,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

LBAjax = (function() {
  function LBAjax() {
    this.upload = bind(this.upload, this);
    this.write = bind(this.write, this);
    this.more = bind(this.more, this);
    this.update = bind(this.update, this);
    this._diff = bind(this._diff, this);
    this.page = bind(this.page, this);
    this.MESSAGE_PER_PAGE = 15;
    this.lastData = [];
  }

  LBAjax.prototype.page = function(success, page, per) {
    lbNotify.progress("データ取得中");
    return $.getJSON("/timeline", {
      page: page,
      per: per
    }, function(data) {
      lbNotify.hide();
      return success(data);
    });
  };

  LBAjax.prototype._diff = function(success, page, per) {
    var _success;
    _success = success;
    return this.page(((function(_this) {
      return function(data) {
        var diff;
        diff = messageDiff(_this.lastData, data);
        diff.sort(sortByDate);
        _success(diff);
        return _this.lastData = _this.lastData.concat(diff);
      };
    })(this)), page, per);
  };

  LBAjax.prototype.update = function(success) {
    return this._diff(success, 0, this.MESSAGE_PER_PAGE);
  };

  LBAjax.prototype.more = function(success) {
    return this._diff(success, Math.floor(this.lastData.length / this.MESSAGE_PER_PAGE), this.MESSAGE_PER_PAGE);
  };

  LBAjax.prototype.write = function(data, success) {
    lbNotify.progress("送信中");
    return $.ajax({
      url: "/timeline",
      type: "post",
      data: data,
      success: (function(_this) {
        return function(res) {
          if (res) {
            lbNotify.hide();
            return success();
          } else {
            return lbNotify.warning("送信に失敗しました");
          }
        };
      })(this),
      error: (function(_this) {
        return function(res) {
          return lbNotify.warning("ユーザ名と本文が必要です");
        };
      })(this)
    });
  };

  LBAjax.prototype.upload = function(files, success) {
    var fd, file, i, len;
    fd = new FormData();
    for (i = 0, len = files.length; i < len; i++) {
      file = files[i];
      fd.append("files", file);
    }
    lbNotify.progress("アップロード中");
    return $.ajax({
      url: "/upload",
      type: "post",
      data: fd,
      processData: false,
      contentType: false,
      success: function(response) {
        lbNotify.hide();
        return success(response);
      }
    });
  };

  return LBAjax;

})();
